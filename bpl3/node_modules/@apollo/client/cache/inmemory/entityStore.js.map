{"version":3,"file":"entityStore.js","sources":["entityStore.js"],"sourcesContent":["import { __assign, __extends } from \"tslib\";\nimport { dep, KeyTrie } from 'optimism';\nimport { invariant } from 'ts-invariant';\nimport { equal } from '@wry/equality';\nimport { isReference } from '../../utilities/graphql/storeUtils';\nimport { DeepMerger, } from '../../utilities/common/mergeDeep';\nimport { canUseWeakMap } from '../../utilities/common/canUse';\nimport { getTypenameFromStoreObject, fieldNameFromStoreName, } from './helpers';\nvar hasOwn = Object.prototype.hasOwnProperty;\nvar EntityStore = (function () {\n    function EntityStore() {\n        this.data = Object.create(null);\n        this.rootIds = Object.create(null);\n        this.refs = Object.create(null);\n    }\n    EntityStore.prototype.toObject = function () {\n        return __assign({}, this.data);\n    };\n    EntityStore.prototype.has = function (dataId) {\n        return this.get(dataId) !== void 0;\n    };\n    EntityStore.prototype.get = function (dataId) {\n        this.group.depend(dataId);\n        return this.data[dataId];\n    };\n    EntityStore.prototype.getFieldValue = function (dataId, storeFieldName) {\n        this.group.depend(dataId, storeFieldName);\n        var storeObject = this.data[dataId];\n        return storeObject && storeObject[storeFieldName];\n    };\n    EntityStore.prototype.merge = function (dataId, incoming) {\n        var _this = this;\n        var existing = this.get(dataId);\n        var merged = new DeepMerger(storeObjectReconciler)\n            .merge(existing, incoming, this);\n        if (merged !== existing) {\n            this.data[dataId] = merged;\n            delete this.refs[dataId];\n            if (this.group.caching) {\n                this.group.dirty(dataId);\n                Object.keys(incoming).forEach(function (storeFieldName) {\n                    if (!existing || incoming[storeFieldName] !== existing[storeFieldName]) {\n                        _this.group.dirty(dataId, storeFieldName);\n                    }\n                });\n            }\n        }\n    };\n    EntityStore.prototype.delete = function (dataId, fieldName) {\n        var _this = this;\n        var storeObject = this.get(dataId);\n        if (storeObject) {\n            fieldName = fieldName && fieldNameFromStoreName(fieldName);\n            var storeNamesToDelete_1 = [];\n            Object.keys(storeObject).forEach(function (storeFieldName) {\n                if (storeObject[storeFieldName] !== void 0 &&\n                    (!fieldName || fieldName === fieldNameFromStoreName(storeFieldName))) {\n                    storeNamesToDelete_1.push(storeFieldName);\n                }\n            });\n            if (storeNamesToDelete_1.length) {\n                var canDelete_1 = this instanceof EntityStore.Root;\n                var remove_1 = function (obj, key) {\n                    if (canDelete_1) {\n                        delete obj[key];\n                    }\n                    else {\n                        obj[key] = void 0;\n                    }\n                };\n                delete this.refs[dataId];\n                var fieldsToDirty_1 = Object.create(null);\n                if (fieldName) {\n                    var cleaned_1 = this.data[dataId] = __assign({}, storeObject);\n                    storeNamesToDelete_1.forEach(function (storeFieldName) {\n                        remove_1(cleaned_1, storeFieldName);\n                    });\n                    fieldsToDirty_1[fieldName] = true;\n                }\n                else {\n                    remove_1(this.data, dataId);\n                    storeNamesToDelete_1.forEach(function (storeFieldName) {\n                        var fieldName = fieldNameFromStoreName(storeFieldName);\n                        fieldsToDirty_1[fieldName] = true;\n                    });\n                }\n                if (this.group.caching) {\n                    this.group.dirty(dataId);\n                    Object.keys(fieldsToDirty_1).forEach(function (fieldName) {\n                        _this.group.dirty(dataId, fieldName);\n                    });\n                }\n            }\n        }\n    };\n    EntityStore.prototype.clear = function () {\n        this.replace(null);\n    };\n    EntityStore.prototype.replace = function (newData) {\n        var _this = this;\n        Object.keys(this.data).forEach(function (dataId) {\n            if (!(newData && hasOwn.call(newData, dataId))) {\n                _this.delete(dataId);\n            }\n        });\n        if (newData) {\n            Object.keys(newData).forEach(function (dataId) {\n                _this.merge(dataId, newData[dataId]);\n            });\n        }\n    };\n    EntityStore.prototype.retain = function (rootId) {\n        return this.rootIds[rootId] = (this.rootIds[rootId] || 0) + 1;\n    };\n    EntityStore.prototype.release = function (rootId) {\n        if (this.rootIds[rootId] > 0) {\n            var count = --this.rootIds[rootId];\n            if (!count)\n                delete this.rootIds[rootId];\n            return count;\n        }\n        return 0;\n    };\n    EntityStore.prototype.getRootIdSet = function () {\n        return new Set(Object.keys(this.rootIds));\n    };\n    EntityStore.prototype.gc = function () {\n        var _this = this;\n        var ids = this.getRootIdSet();\n        var snapshot = this.toObject();\n        ids.forEach(function (id) {\n            if (hasOwn.call(snapshot, id)) {\n                Object.keys(_this.findChildRefIds(id)).forEach(ids.add, ids);\n                delete snapshot[id];\n            }\n        });\n        var idsToRemove = Object.keys(snapshot);\n        if (idsToRemove.length) {\n            var root_1 = this;\n            while (root_1 instanceof Layer)\n                root_1 = root_1.parent;\n            idsToRemove.forEach(function (id) { return root_1.delete(id); });\n        }\n        return idsToRemove;\n    };\n    EntityStore.prototype.findChildRefIds = function (dataId) {\n        if (!hasOwn.call(this.refs, dataId)) {\n            var found_1 = this.refs[dataId] = Object.create(null);\n            var workSet_1 = new Set([this.data[dataId]]);\n            var canTraverse_1 = function (obj) { return obj !== null && typeof obj === 'object'; };\n            workSet_1.forEach(function (obj) {\n                if (isReference(obj)) {\n                    found_1[obj.__ref] = true;\n                }\n                else if (canTraverse_1(obj)) {\n                    Object.values(obj)\n                        .filter(canTraverse_1)\n                        .forEach(workSet_1.add, workSet_1);\n                }\n            });\n        }\n        return this.refs[dataId];\n    };\n    EntityStore.prototype.makeCacheKey = function () {\n        var args = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            args[_i] = arguments[_i];\n        }\n        return this.group.keyMaker.lookupArray(args);\n    };\n    return EntityStore;\n}());\nexport { EntityStore };\nvar CacheGroup = (function () {\n    function CacheGroup(caching) {\n        this.caching = caching;\n        this.d = null;\n        this.keyMaker = new KeyTrie(canUseWeakMap);\n        this.d = caching ? dep() : null;\n    }\n    CacheGroup.prototype.depend = function (dataId, storeFieldName) {\n        if (this.d) {\n            this.d(makeDepKey(dataId, storeFieldName));\n        }\n    };\n    CacheGroup.prototype.dirty = function (dataId, storeFieldName) {\n        if (this.d) {\n            this.d.dirty(typeof storeFieldName === \"string\"\n                ? makeDepKey(dataId, storeFieldName)\n                : makeDepKey(dataId));\n        }\n    };\n    return CacheGroup;\n}());\nfunction makeDepKey(dataId, storeFieldName) {\n    var parts = [dataId];\n    if (typeof storeFieldName === \"string\") {\n        parts.push(fieldNameFromStoreName(storeFieldName));\n    }\n    return JSON.stringify(parts);\n}\n(function (EntityStore) {\n    var Root = (function (_super) {\n        __extends(Root, _super);\n        function Root(_a) {\n            var _b = _a.resultCaching, resultCaching = _b === void 0 ? true : _b, seed = _a.seed;\n            var _this = _super.call(this) || this;\n            _this.sharedLayerGroup = null;\n            _this.group = new CacheGroup(resultCaching);\n            _this.sharedLayerGroup = new CacheGroup(resultCaching);\n            if (seed)\n                _this.replace(seed);\n            return _this;\n        }\n        Root.prototype.addLayer = function (layerId, replay) {\n            return new Layer(layerId, this, replay, this.sharedLayerGroup);\n        };\n        Root.prototype.removeLayer = function (layerId) {\n            return this;\n        };\n        return Root;\n    }(EntityStore));\n    EntityStore.Root = Root;\n})(EntityStore || (EntityStore = {}));\nvar Layer = (function (_super) {\n    __extends(Layer, _super);\n    function Layer(id, parent, replay, group) {\n        var _this = _super.call(this) || this;\n        _this.id = id;\n        _this.parent = parent;\n        _this.replay = replay;\n        _this.group = group;\n        replay(_this);\n        return _this;\n    }\n    Layer.prototype.addLayer = function (layerId, replay) {\n        return new Layer(layerId, this, replay, this.group);\n    };\n    Layer.prototype.removeLayer = function (layerId) {\n        var _this = this;\n        var parent = this.parent.removeLayer(layerId);\n        if (layerId === this.id) {\n            if (this.group.caching) {\n                Object.keys(this.data).forEach(function (dataId) { return _this.delete(dataId); });\n            }\n            return parent;\n        }\n        if (parent === this.parent)\n            return this;\n        return parent.addLayer(this.id, this.replay);\n    };\n    Layer.prototype.toObject = function () {\n        return __assign(__assign({}, this.parent.toObject()), this.data);\n    };\n    Layer.prototype.get = function (dataId) {\n        if (hasOwn.call(this.data, dataId)) {\n            return _super.prototype.get.call(this, dataId);\n        }\n        if (this.group.caching && this.group !== this.parent.group) {\n            this.group.depend(dataId);\n        }\n        return this.parent.get(dataId);\n    };\n    Layer.prototype.getFieldValue = function (dataId, storeFieldName) {\n        if (hasOwn.call(this.data, dataId)) {\n            var storeObject = this.data[dataId];\n            if (storeObject && hasOwn.call(storeObject, storeFieldName)) {\n                return _super.prototype.getFieldValue.call(this, dataId, storeFieldName);\n            }\n        }\n        if (this.group.caching && this.group !== this.parent.group) {\n            this.group.depend(dataId, storeFieldName);\n        }\n        return this.parent.getFieldValue(dataId, storeFieldName);\n    };\n    Layer.prototype.getRootIdSet = function () {\n        var ids = this.parent.getRootIdSet();\n        _super.prototype.getRootIdSet.call(this).forEach(ids.add, ids);\n        return ids;\n    };\n    Layer.prototype.findChildRefIds = function (dataId) {\n        var fromParent = this.parent.findChildRefIds(dataId);\n        return hasOwn.call(this.data, dataId) ? __assign(__assign({}, fromParent), _super.prototype.findChildRefIds.call(this, dataId)) : fromParent;\n    };\n    return Layer;\n}(EntityStore));\nvar storeObjectReconciler = function (existingObject, incomingObject, property, store) {\n    var existing = existingObject[property];\n    var incoming = incomingObject[property];\n    if (existing !== incoming &&\n        this.isObject(existing) &&\n        this.isObject(incoming)) {\n        var eType = getTypenameFromStoreObject(store, existing);\n        var iType = getTypenameFromStoreObject(store, incoming);\n        if (typeof eType === 'string' &&\n            typeof iType === 'string' &&\n            eType !== iType) {\n            return incoming;\n        }\n        invariant(!isReference(existing) || isReference(incoming), \"Store error: the application attempted to write an object with no provided id but the store already contains an id of \" + existing.__ref + \" for this object.\");\n        if (equal(existing, incoming)) {\n            return existing;\n        }\n    }\n    return incoming;\n};\nexport function supportsResultCaching(store) {\n    return !!(store instanceof EntityStore && store.group.caching);\n}\nexport function defaultNormalizedCacheFactory(seed) {\n    return new EntityStore.Root({ resultCaching: true, seed: seed });\n}\n//# sourceMappingURL=entityStore.js.map"],"names":[],"mappings":"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"}